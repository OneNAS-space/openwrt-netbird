name: Build OpenWrt Package

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Check And Calculate PKG_HASH"]
    types:
      - completed

permissions:
  contents: write

jobs:
  build:
    name: Build for (${{ matrix.platform }})
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'update netbird')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/24.10.5/targets/x86/64/openwrt-sdk-24.10.5-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/releases/24.10.5/targets/qualcommax/ipq807x/openwrt-sdk-24.10.5-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/releases/24.10.5/targets/ipq40xx/generic/openwrt-sdk-24.10.5-ipq40xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v6

      - name: ğŸ” Decide whether build is needed (fingerprint compare)
        id: need
        env:
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
        run: |
          echo "Trigger commit message: $COMMIT_MSG"
          FP=$(echo "$COMMIT_MSG" | sed -n 's/.*FP=\([0-9a-f]\{64\}\).*/\1/p')
          if [ -z "$FP" ]; then
            echo "No FP found in commit message; default to build."
            echo "need=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -f .last-fingerprint ]; then
            LAST=$(cat .last-fingerprint)
          else
            LAST=""
          fi
          echo "Current FP: $FP"
          echo "Last FP: $LAST"
          if [ "$FP" = "$LAST" ]; then
            echo "Fingerprint unchanged; skip build."
            echo "need=false" >> $GITHUB_OUTPUT
          else
            echo "Fingerprint changed; proceed to build."
            echo "need=true" >> $GITHUB_OUTPUT

      - name: â›” Exit early if no build needed
        if: steps.need.outputs.need == 'false'
        run: |
          echo "No build needed. Exiting."
          exit 0
          
      - name: ğŸ› ï¸ Install dependencies
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
              bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
              g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
              libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
              libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
              ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
              python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
              upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Cache OpenWrt dl
        uses: actions/cache@v5
        with:
          path: sdk/dl
          key: ${{ runner.os }}-openwrt-${{ matrix.sdk_ver }}-${{ matrix.platform }}

      - name: ğŸ—ï¸ Initialization environment
        run: |
          wget ${{ matrix.url_sdk }}
          file_name=$(echo ${{matrix.url_sdk}} | awk -F/ '{print $NF}')
          mkdir -p sdk
          find sdk -mindepth 1 -maxdepth 1 ! -name dl -exec rm -rf {} +

          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "Unsupported file format: $file_name"
            exit 1
           fi
          cd sdk

          # 2. åˆ‡æ¢ GitHub æºå¹¶æ›´æ–° feeds
          sed -i 's|git.openwrt.org/feed|github.com/openwrt|g' feeds.conf.default
          sed -i 's|git.openwrt.org/project|github.com/openwrt|g' feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 3. ğŸ§ª Apply Patch: å¼ºåˆ¶å‡çº§ Golang ç‰ˆæœ¬åˆ°æœ€æ–°
          # è¿™ä¸€æ­¥å‚è€ƒä½ æä¾›çš„ä»£ç ï¼Œç¡®ä¿ netbird ç¼–è¯‘æ—¶ä½¿ç”¨çš„ go ç¯å¢ƒè¶³å¤Ÿæ–°
          rm -rf temp_resp
          git clone -b master --single-branch https://github.com/openwrt/packages.git temp_resp
          echo "Updating Golang to latest from packages.git"
          rm -rf feeds/packages/lang/golang
          cp -r temp_resp/lang/golang feeds/packages/lang/
          rm -rf temp_resp
          echo "Force rebuilding golang host tool..."
          rm -rf staging_dir/hostpkg/bin/go
          rm -rf staging_dir/hostpkg/lib/go
          
          # å†æ¬¡åˆ·æ–°ä»¥åº”ç”¨ patch
          ./scripts/feeds update -i
          ./scripts/feeds install -a

          # 4. ğŸ”€ å¼ºè¡Œè¦†ç›–å®˜æ–¹ netbird æºç 
          # å…ˆæ¸…ç†å®˜æ–¹è·¯å¾„
          echo "Removing official netbird source..."
          rm -rf feeds/packages/net/netbird/*
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ï¼ˆé’ˆå¯¹æŸäº› SDK ç»“æ„ï¼‰
          mkdir -p feeds/packages/net/netbird
          
          # å°†å½“å‰ä»“åº“ä»£ç ï¼ˆçˆ¶ç›®å½•ï¼‰è¦†ç›–è¿›å»
          echo "Copying custom netbird source to official feed path..."
          cp ../Makefile ./feeds/packages/net/netbird/
          [ -d "../files" ] && cp -r ../files ./feeds/packages/net/netbird/

          # 5. åˆ·æ–°ç´¢å¼•ç¡®è®¤
          ./scripts/feeds install -f golang
          ./scripts/feeds install -f netbird

      - name: ğŸ§® Compile netbird
        run: |
          cd sdk
          export GOPROXY=https://proxy.golang.org,direct
          # ç”Ÿæˆ .config å¹¶å¼ºåˆ¶é€‰æ‹© netbird
          echo "CONFIG_PACKAGE_netbird=m" > .config
          
          # å¤„ç†ä¾èµ–å…³ç³»
          make defconfig
          
          # å¼€å§‹ç¼–è¯‘
          echo "Starting compilation..."
          make package/netbird/compile V=s -j$(nproc)

      - name: ğŸ” Debug build output
        run: |
          echo "=== Build directory structure ==="
          find . -name "*.ipk" -type f 2>/dev/null || echo "No .ipk files found"
          echo "=== bin directory structure ==="
          ls -la bin/ 2>/dev/null || echo "No bin directory found"
          if [ -d "bin/packages" ]; then
            echo "=== packages directory structure ==="
            find bin/packages/ -type f -name "*.ipk" 2>/dev/null || echo "No .ipk files in packages directory"
          fi

      - name: ğŸ“¦ Upload artifact for (${{ matrix.platform }})
        uses: actions/upload-artifact@v7
        with:
          name: netbird-${{ matrix.platform }}-${{ matrix.sdk_ver }}
          path: |
            sdk/bin/packages/*/packages/netbird*.ipk
          if-no-files-found: ignore

  release:
    name: Release ${{ github.repository }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v6

      - name: ğŸ” Extract version and release from Makefile
        id: version
        run: |
          # ä»…ä¿ç•™é’ˆå¯¹æ ‡å‡† PKG_VERSION çš„æå–é€»è¾‘
          PKG_VERSION=$(grep -E '^PKG_VERSION *:?=' Makefile | head -n1 | cut -d= -f2 | tr -d '[:space:]')
          PKG_RELEASE=$(grep -E '^PKG_RELEASE *:?=' Makefile | head -n1 | cut -d= -f2 | tr -d '[:space:]')
          
          COMBINED_VERSION="${PKG_VERSION}-${PKG_RELEASE}"
          echo "ğŸ“¦ Version: $COMBINED_VERSION"
          echo "version=$PKG_VERSION" >> "$GITHUB_OUTPUT"
          echo "full_version=$COMBINED_VERSION" >> "$GITHUB_OUTPUT"

      - name: ğŸ›‘ Check if release already exists
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v${{ steps.version.outputs.full_version }}"
          echo "Checking for existing release tag: $TAG_NAME"
          
          if gh release view "$TAG_NAME" > /dev/null 2>&1; then
            echo "âœ… Release $TAG_NAME already exists."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸš€ Release $TAG_NAME does not exist. Proceeding with release."
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: â¬‡ï¸ Download all build artifacts
        if: steps.check_release.outputs.exists == 'false'
        uses: actions/download-artifact@v7
        with:
          path: ./release-assets

      - name: ğŸ—ƒï¸ Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.full_version }}
          name: Build-v${{ steps.version.outputs.version }}
          files: |
            ./release-assets/**/netbird*.ipk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout custom-packages repo
        if: steps.check_release.outputs.exists == 'false'
        uses: actions/checkout@v6
        with:
          repository: OneNAS-space/custom-packages
          token: ${{ secrets.CUSTOM_PACKAGES_TOKEN }}
          path: custom-packages

      - name: ğŸ“‚ Copy artifacts into repo
        if: steps.check_release.outputs.exists == 'false'
        run: |
          # æå–å¯¹åº”æ¶æ„ç›®å½•å¹¶æ¸…ç†æ—§åŒ…
          find ./release-assets -type f -name "netbird*.ipk" | while read -r f; do
            base=$(basename "$f")
            pkgname=$(echo "$base" | sed -E 's/^([^_]+)_.*$/\1/')
            archdir=$(echo "$f" | sed -E 's#.*/netbird-([^/]+)-openwrt.*#\1#')
            echo "Processing $pkgname for arch $archdir"
            
            mkdir -p "custom-packages/$archdir"
            echo "Cleaning old versions of $pkgname in $archdir"
            rm -f "custom-packages/$archdir/${pkgname}_*.ipk"
            
            cp "$f" "custom-packages/$archdir/"
          done
          ls -laR custom-packages

      - name: Update pkg artifacts
        if: steps.check_release.outputs.exists == 'false'
        run: |
          cd custom-packages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update netbird to v${{ steps.version.outputs.full_version }}" || echo "No changes"
          git push
