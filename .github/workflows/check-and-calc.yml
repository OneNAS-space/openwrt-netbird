name: Check And Calculate PKG_HASH

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - "Makefile"

permissions:
  contents: write

jobs:
  check_and_calc:
    name: Check upstream and calculate PKG_HASH
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ” Check for updates
        id: check
        run: |
          set -euo pipefail
          # 1. è·å–æœ¬åœ° Makefile ä¸­çš„å½“å‰ç‰ˆæœ¬
          CURRENT_VER=$(grep '^PKG_VERSION:=' Makefile | awk -F= '{print $2}' | tr -d '[:space:]')
          # 2. è·å–æœ€æ–° Release Tag
          REMOTE_VER=$(curl -s "https://api.github.com/repos/netbirdio/netbird/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
          
          echo "Current: $CURRENT_VER"
          echo "Remote:  $REMOTE_VER"

          if [ "$REMOTE_VER" = "null" ] || [ -z "$REMOTE_VER" ]; then
            echo "âŒ Failed to get remote version."
            exit 1
          fi

          if [ "$CURRENT_VER" = "$REMOTE_VER" ]; then
            echo "âœ… Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸš€ New version found: $REMOTE_VER"
            # å…ˆæ›´æ–°ç‰ˆæœ¬å·ï¼Œä»¥ä¾¿åç»­ SDK è„šæœ¬èƒ½è¯†åˆ«æ–°ç‰ˆæœ¬ä¸‹è½½é“¾æ¥
            sed -i "s|^PKG_VERSION:=.*|PKG_VERSION:=$REMOTE_VER|" Makefile
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "new_ver=$REMOTE_VER" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¥ Get SDK Fingerprint (sha256sums)
        if: steps.check.outputs.updated == 'true'
        run: |
          # ä½¿ç”¨ 24.10.5 x86_64 ä½œä¸ºè®¡ç®—å“ˆå¸Œçš„æ ‡å‡†ç¯å¢ƒ
          BASE_URL="https://downloads.openwrt.org/releases/24.10.5/targets/x86/64"
          wget -q ${BASE_URL}/sha256sums
          SDK_HASH=$(grep "openwrt-sdk" sha256sums | awk '{print $1}')
          SDK_FILE=$(grep "openwrt-sdk" sha256sums | awk '{print $2}' | sed 's/^\*//')
          echo "SDK_HASH=$SDK_HASH" >> $GITHUB_ENV
          echo "SDK_FILE=$SDK_FILE" >> $GITHUB_ENV
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV

      - name: â™»ï¸ Cache OpenWrt SDK
        id: cache
        if: steps.check.outputs.updated == 'true'
        uses: actions/cache@v5
        with:
          path: openwrt-sdk
          key: sdk-calc-${{ env.SDK_HASH }}

      - name: ğŸ“¦ Download & Extract OpenWrt SDK
        if: steps.check.outputs.updated == 'true' && steps.cache.outputs.cache-hit != 'true'
        run: |
          wget -q ${{ env.BASE_URL }}/${{ env.SDK_FILE }}
          echo "${{ env.SDK_HASH }}  ${{ env.SDK_FILE }}" | sha256sum -c -
          rm -rf openwrt-sdk
          mkdir -p openwrt-sdk
          tar -I zstd -xf ${{ env.SDK_FILE }} -C openwrt-sdk --strip-components=1
          if [ -f "openwrt-sdk/scripts/feeds" ]; then
            echo "âœ… SDK extracted successfully."
          else
            echo "âŒ Error: SDK structure is unexpected."
            ls -R openwrt-sdk | head -n 20
            exit 1
          fi

      - name: ğŸ” Download and Calculate Hash via SDK
        id: calc
        if: steps.check.outputs.updated == 'true'
        run: |
          # 1. å‡†å¤‡ SDK ç›®å½•ç»“æ„
          mkdir -p openwrt-sdk/package/netbird
          cp Makefile openwrt-sdk/package/netbird/
          [ -d "files" ] && cp -r files openwrt-sdk/package/netbird/

          cd openwrt-sdk
          # 2. å¿…é¡»æ›´æ–° feed å¦åˆ™ SDK æ— æ³•è¯†åˆ« golang ç›¸å…³å®
          ./scripts/feeds update packages
          ./scripts/feeds install golang

          # 3. å¼ºåˆ¶ SDK ä¸‹è½½æºç  (è·³è¿‡æ—§å“ˆå¸Œæ ¡éªŒ)
          echo "â¬‡ï¸ Downloading source via SDK..."
          make package/netbird/download PKG_HASH=skip V=s
          
          # 4. æå–ä¸‹è½½æ–‡ä»¶çš„å“ˆå¸Œå€¼
          # Netbird ä¸‹è½½çš„æ–‡ä»¶åé€šå¸¸æ˜¯ netbird-x.x.x.tar.gz
          DOWNLOADED_FILE=$(find dl -type f -name "netbird-*.tar.gz" | head -n 1)
          if [ -z "$DOWNLOADED_FILE" ]; then
            echo "âŒ Download failed."
            exit 1
          fi
          NEW_HASH=$(sha256sum "$DOWNLOADED_FILE" | awk '{print $1}')
          echo "ğŸ§® Calculated PKG_HASH: $NEW_HASH"
          echo "NEW_HASH=$NEW_HASH" >> $GITHUB_OUTPUT

      - name: ğŸ“ Update Makefile and Push
        if: steps.check.outputs.updated == 'true'
        run: |
          NEW_HASH="${{ steps.calc.outputs.NEW_HASH }}"
          NEW_VER="${{ steps.check.outputs.new_ver }}"
          
          # å›å¡«æ­£ç¡®çš„å“ˆå¸Œå€¼
          sed -i "s|^PKG_HASH:=.*|PKG_HASH:=$NEW_HASH|" Makefile
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Makefile
          
          if git diff-index --quiet HEAD --; then
            echo "â„¹ï¸ No changes."
          else
            git commit -m "chore: update netbird to v$NEW_VER and fix PKG_HASH"
            git push
          fi
