name: Check And Calculate PKG_HASH

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - "Makefile"

permissions:
  contents: write

jobs:
  check_and_calc:
    name: Check upstream and calculate PKG_HASH
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ” Check for updates
        id: check
        run: |
          set -euo pipefail

          # 1. è·å–æœ¬åœ° Makefile ä¸­çš„å½“å‰ç‰ˆæœ¬
          CURRENT_VER=$(grep '^PKG_VERSION:=' Makefile | awk -F= '{print $2}' | tr -d '[:space:]')
          
          # 2. é€šè¿‡ GitHub API è·å– netbird çš„æœ€æ–° Release Tag (å¹¶å»æ‰ 'v' å‰ç¼€)
          REMOTE_VER=$(curl -s "https://api.github.com/repos/netbirdio/netbird/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
          
          echo "Current: $CURRENT_VER"
          echo "Remote:  $REMOTE_VER"

          if [ -z "$REMOTE_VER" ] || [ "$REMOTE_VER" = "null" ]; then
            echo "âŒ Failed to get remote version."
            exit 1
          fi

          if [ "$CURRENT_VER" = "$REMOTE_VER" ]; then
            echo "âœ… Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸš€ New version found! Updating Makefile..."

          # 3. æ›¿æ¢ Makefile ä¸­çš„ PKG_VERSION
          sed -i "s|^PKG_VERSION:=.*|PKG_VERSION:=$REMOTE_VER|" Makefile

          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_ver=$REMOTE_VER" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ Download source and Calculate Hash manually
        id: calc
        if: steps.check.outputs.updated == 'true'
        run: |
          NEW_VER=${{ steps.check.outputs.new_ver }}
          
          # æ‹¼æ¥å¯¹åº”ç‰ˆæœ¬çš„æºç åŒ…ä¸‹è½½é“¾æ¥ (å¯¹åº” Makefile ä¸­çš„ PKG_SOURCE_URL)
          TAR_URL="https://codeload.github.com/netbirdio/netbird/tar.gz/v${NEW_VER}?"
          
          echo "â¬‡ï¸ Downloading source: $TAR_URL"
          wget -qO netbird.tar.gz "$TAR_URL"
          
          # 4. è®¡ç®— SHA256 Hash
          NEW_HASH=$(sha256sum netbird.tar.gz | awk '{print $1}')
          echo "ğŸ§® Calculated Hash: $NEW_HASH"
          
          if [ -z "$NEW_HASH" ]; then
            echo "âŒ Failed to calculate new hash."
            exit 1
          fi
          
          # 5. æ›¿æ¢ Makefile ä¸­çš„ PKG_HASH
          sed -i "s|^PKG_HASH:=.*|PKG_HASH:=$NEW_HASH|" Makefile

      - name: ğŸ“ Commit and Push changes
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Makefile
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ”¹åŠ¨ï¼Œé¿å…ç©ºæäº¤æŠ¥é”™
          if git diff-index --quiet HEAD --; then
            echo "â„¹ï¸ No changes to commit."
            exit 0
          fi
          
          NEW_VER=${{ steps.check.outputs.new_ver }}
          git commit -m "chore: update netbird to v$NEW_VER"
          git push
